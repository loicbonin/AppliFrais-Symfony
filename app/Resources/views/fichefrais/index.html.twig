{% extends 'base.html.twig' %}

{% block body %}
    <div style="margin: 25px;" class="green-text">
        <i class="material-icons left green-text">sync</i>Fiches frais du mois
        <div class="divider green"></div>
    </div>
    <ul class="collapsible popout" data-collapsible="accordion">
        <li class="active">
            <div class="collapsible-header">
                <i class="material-icons blue-text text-darken-4">note</i>
                {{ onefichefrais.monthyear }}
                <tr>
                    <th>|  état: </th>
                    <td>
                        {% if onefichefrais.etat %}
                            {{ onefichefrais.etat }}
                        {% else %}
                            Ouvert
                        {% endif %}
                    </td>
                    <th>|  Montant total: </th>
                    <td>
                        {% set totalFrai = 0 %}
                        {% set totalHorsFrai = 0 %}
                        {% set totalFicheFrai = 0 %}
                        {% for Frai in onefichefrais.frais %}
                            {% set totalFrai = (Frai.quantity * Frai.forfait.unitPrice) + totalFrai %}
                        {% endfor %}
                        {% for HorsFrai in onefichefrais.horsFrais %}
                            {% set totalHorsFrai = HorsFrai.price + totalHorsFrai %}
                        {% endfor %}
                        {% set totalFicheFrai = totalHorsFrai + totalFrai %}
                        {{ totalFicheFrai }}€
                    </td>
                </tr>

            </div>
            <div class="collapsible-body">

                <table class="bordered highlight">
                    <thead>
                    <tr>
                        <th>Type de Frais</th>
                        <th>Date</th>
                        <th>Intitulé</th>
                        <th>Prix</th>
                        <th>Commentaire</th>
                        <th>Etat</th>
                        <th>Pièce jointe</th>
                        {% if "now"|date("d") < 11 %}
                            <th>action(s)</th>
                        {% endif %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for HorsFrai in onefichefrais.horsFrais %}
                        <tr>
                            <td>Hors Forfait</td>
                            <td>{% if HorsFrai.dateDuFrais %}{{ HorsFrai.dateDuFrais|date('Y-m-d H:i:s') }}{% endif %}</td>
                            <td>{{ HorsFrai.wording }}</td>
                            <td>{{ HorsFrai.price }} €</td>
                            <td>
                                {% if HorsFrai.comment %}
                                    {{ HorsFrai.comment }}
                                {% else %}
                                    Pas de commentaire
                                {% endif %}
                            </td>
                            <td>
                                {% if HorsFrai.etat is not null %}
                                    {{ HorsFrai.etat.wording }}
                                {% else %}
                                    Pas encore traité
                                {% endif %}
                            </td>
                            <td>
                                {% if HorsFrai.pieceJointe %}
                            <a href="{{ asset('uploads/pieceJointes/' ~ HorsFrai.pieceJointe) }}">Voir la pièce jointe</a>
                                {% else %}
                                    Pas de pièce jointe
                                {% endif %}
                            </td>
                            {# {% if "now"|date("d") < 11 %} #}
                                <td>
                                    <a href="{{ path('forfaithorsfrais_edit', { 'id': HorsFrai.id }) }}">Modifier</a>
                                </td>
                            {# {% endif %} #}

                        </tr>
                    {% endfor %}
                    {% for Frai in onefichefrais.frais %}
                        <tr>
                            <td>Forfait</td>
                            <td>{% if Frai.dateDuFrais %}{{ Frai.dateDuFrais|date('Y-m-d H:i:s') }}{% endif %}</td>
                            <td>{{ Frai.forfait.wording }}</td>
                            <td>{{ Frai.quantity * Frai.forfait.unitPrice }} €</td>
                            <td>
                                {% if Frai.comment %}
                                    {{ Frai.comment }}
                                {% else %}
                                    Pas de commentaire
                                {% endif %}
                            </td>
                            <td>
                                {% if Frai.etat is not null %}
                                    {{ Frai.etat.wording }}
                                {% else %}
                                    Pas encore traité
                                {% endif %}
                            </td>
                            <td>
                                Pas de pièce jointe
                            </td>
                            {# {% if "now"|date("d") < 11 %} #}
                                <td>
                                    <a href="{{ path('forfaitfrais_edit', { 'id': Frai.id }) }}">Modifier</a>
                                </td>
                            {# {% endif %}  #}
                         </tr>
                     {% endfor %}
                     </tbody>
                 </table>
                 <div style="margin-top: 30px;">
                     <a href="{{ path('fichefrais_pdf', { 'id': onefichefrais.id, 'name': attribute(onefichefrais, 'MonthYear')}) }}" target="_blank" title="Generer pdf" class="waves-effect waves-light btn red darken-2"><i class="material-icons left">picture_as_pdf</i>Generer pdf</a>
                    {# <a class="waves-effect waves-light btn red darken-2"><i class="material-icons left">picture_as_pdf</i>Generer pdf</a>#}
                </div>
            </div>
        </li>
    </ul>
    <div style="margin: 25px;" class="grey-text">
        <i class="material-icons left grey-text">archive</i>Fiches frais cloturées
        <div class="divider"></div>
    </div>
    <ul class="collapsible popout" data-collapsible="accordion">
        {% for ficheFrai in allexceptlast %}
            <li>
                <div class="collapsible-header">
                    <i class="material-icons blue-text text-darken-4">note</i>
                    {{ ficheFrai.monthyear }}
                    <tr>
                        <th>|  état: </th>
                        <td>
                            {% if onefichefrais.etat %}
                                {{ onefichefrais.etat }}
                            {% else %}
                                En traitement
                            {% endif %}
                        </td>
                        <th>|  Montant total: </th>
                        <td>
                            {% set totalFrai = 0 %}
                            {% set totalHorsFrai = 0 %}
                            {% set totalFicheFrai = 0 %}
                            {% for Frai in ficheFrai.frais %}
                                {% set totalFrai = (Frai.quantity * Frai.forfait.unitPrice) + totalFrai %}
                            {% endfor %}
                            {% for HorsFrai in ficheFrai.horsFrais %}
                                {% set totalHorsFrai = HorsFrai.price + totalHorsFrai %}
                            {% endfor %}
                            {% set totalFicheFrai = totalHorsFrai + totalFrai %}
                            {{ totalFicheFrai }}€
                        </td>
                    </tr>
                </div>
                <div class="collapsible-body">
                    <table class="bordered highlight">
                        <thead>
                            <tr>
                              <th>Type de Frais</th>
                              <th>Intitulé</th>
                              <th>Prix</th>
                              <th>Date</th>
                              <th>Commentaire</th> 
                              <th>Pièce jointe</th>
                            </tr>
                        </thead>
                        <tbody>
                          {% for HorsFrai in ficheFrai.horsFrais %}
                              <tr>
                                  <td>Hors Forfait</td>
                                  <td>{{ HorsFrai.wording }}</td>
                                  <td>{{ HorsFrai.price }} €</td>
                                  <td>{% if HorsFrai.dateDuFrais %}{{ HorsFrai.dateDuFrais|date('Y-m-d H:i:s') }}{% endif %}</td>
                                  <td>{{ HorsFrai.comment }}</td>
                                  <td><a href="{{ asset('uploads/pieceJointes/' ~ HorsFrai.pieceJointe) }}">Voir la pièce jointe</a></td>
                              </tr>
                          {% endfor %}
                          {% for Frai in ficheFrai.frais %}
                              <tr>
                                  <td>Forfait</td>
                                  <td>{{ Frai.type }}</td>
                                  <td>{{ Frai.quantity * Frai.forfait.unitPrice }} €</td>
                                  <td>{% if Frai.dateDuFrais %}{{ Frai.dateDuFrais|date('Y-m-d H:i:s') }}{% endif %}</td>
                                  <td></td>
                                  <td></td>
                              </tr>
                          {% endfor %}
                        </tbody>
                    </table>
                    <div style="margin-top: 30px;">
                      <a class="waves-effect waves-light btn red darken-2"><i class="material-icons left">picture_as_pdf</i>Generer pdf</a>
                    </div>
                </div>
            </li>
        {% endfor %}
    </ul>
    <ul>
        {#<li>
            <a href="{{ path('fichefrais_new') }}">Create a new ficheFrai</a>
        </li>
        <li>
            <a href="{{ path('forfaitfrais_new', { 'ficheFraisId': lastfichefrais.0.id }) }}" class="btn">Ajouter une note de Frais</a>
        </li>
        <li>
            <a href="{{ path('forfaithorsfrais_new', { 'ficheFraisId': lastfichefrais.0.id }) }}" class="btn">Ajouter une note Hors Frais</a>
        </li>#}
    </ul>
{% endblock %}
